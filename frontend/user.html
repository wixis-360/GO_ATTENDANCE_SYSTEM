<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Attendance</title>

    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="css/skins/_all-skins.min.css">

    <!-- Google Font -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    
    <script src="qr/Blob.js"></script>
    <script src="qr/canvas-to-blob.min.js"></script>
    <script src="qr/FileSaver.js"></script>
    <script src="qr/VanillaQR.js"></script>
    
    <style>
        .dataTables_filter {
            text-align: right !important;
        }

        .delete {
            padding: 5px;
        }

        table tbody tr {
            cursor: pointer;
        }

        table tbody tr td {
            vertical-align: middle !important;
        }

        .selected-row {
            background-color: rgba(0, 48, 70, 0.16) !important;
        }
    </style>
</head>

<body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">

        <header class="main-header">
            <!-- Logo -->
            <a href="index" class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini"><b>WIXIS</b>360</span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg"><b>WIXIS</b>360</span>
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top">
                <!-- Sidebar toggle button-->
                <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>
            </nav>
        </header>
        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">
            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">

                <!-- sidebar menu: : style can be found in sidebar.less -->
                <ul class="sidebar-menu" data-widget="tree">
                    <li class="header">MAIN NAVIGATION</li>
                    <li>
                        <a href="index">
                            <i class="fa fa-dashboard"></i> <span>Dashboard</span>
                        </a>
                    </li>

                    <li class="active">
                        <a href="user">
                            <i class="fa fa-user"></i> <span>Manage Users</span>
                        </a>
                    </li>
                </ul>
            </section>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    Manage Users
                    <small>Add,Delete and Search Users</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li class="active">Dashboard</li>
                </ol>
            </section>

            <!-- Main content -->
            <section class="content">

                <!-- Main row -->
                <div class="row">

                    <div class="col-12 col-md-4">

                        <div class="box box-primary">
                            <div class="box-header with-border">
                                <h3 class="box-title">User Information</h3>
                            </div>
                            <!-- /.box-header -->
                            <!-- form start -->
                            <form role="form">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input name="uname" type="text" class="form-control" id="txtuname"
                                            placeholder="Enter Name">
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input name="uemail" type="text" class="form-control" id="txtemail"
                                            placeholder="Enter Email">
                                    </div>
                                    <div class="form-group">
                                        <label>Contact No</label>
                                        <input name="ucontact" type="text" class="form-control" id="txtcontact"
                                            placeholder="Enter Contact Number">
                                    </div>
                                    <div class="form-group">
                                        <label>Gender</label>
                                        <!-- <input name="ugender" type="text" class="form-control" id="txtgender"
                                            placeholder="Enter Gender"> -->
                                            <div class="input-group mb-3">
                                            <select class="custom-select" id="txtgender">
                                                <option value="0" selected>Select Gender</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                              </select>
                                            </div>
                                    </div>
                                </div>
                                <!-- /.box-body -->

                                <div class="box-footer">
                                    <button type="button" id="btnSave" class="btn btn-primary">Save</button>
                                    <button type="reset" class="btn btn-danger">Clear</button>
                                </div>
                            </form>
                        </div>
                        <!-- /.box -->

                    </div>
                    <div class="col-12 col-md-8">

                        <div class="box">
                            <div class="box-body">
                                <table id="tblusers" class="table table-bordered table-hover">
                                    <colgroup>
                                        <col style="width: 70px; text-align: center;">
                                        <col style="width: 120px;">
                                        <col style="width: 120px;">
                                        <col style="width: 120px;">
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th style="text-align: center;">UID</th>
                                            <th style="text-align: center;">Uname</th>
                                            <th style="text-align: center;"> QR Code</th>
                                            <th style="text-align: center;"> Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                </div>
                <!-- /.row (main row) -->

            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->
        <footer class="main-footer">
            <div class="pull-right hidden-xs">
                <b>Version</b> 1.0.0
            </div>
            <strong>Copyright &copy; 2019 <a href="http://wixis360.com">wixis360</a>.</strong> All rights
            reserved.
        </footer>

    </div>
    <!-- ./wrapper -->

    <!-- jQuery 3 -->
    <script src="js/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
        $.widget.bridge('uibutton', $.ui.button);
    </script>
    <!-- Bootstrap 3.3.7 -->
    <script src="js/bootstrap.min.js"></script>
    <!-- DataTables -->
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/dataTables.bootstrap.min.js"></script>
    <!-- Slimscroll -->
    <script src="js/jquery.slimscroll.min.js"></script>
    <!-- FastClick -->
    <script src="js/fastclick.js"></script>
    <!-- AdminLTE App -->
    <script src="js/adminlte.min.js"></script>
    
 
    <script>
        $(function () {
            $('#tblusers').DataTable({
                'paging': true,
                'lengthChange': false,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search  Users..."
                }
            });
        });
    </script>
    <script>
        var SERVER_URL = "http://localhost:8088";
        var allusersindb;
        $("#btnSave").click(function () {
            if ($('#txtcontact').val() == ''|| $('#txtcontact').val()=='' || $('#txtgender').val()=='') {
                alert('Input can not be left blank');
                return;
            }
            if($("#txtgender").val()==0){
                alert("Please Select a Valid Gender Option");
                $("#txtgender").focus();
                return;
            }

            var regName = /^[a-zA-Z]+ [a-zA-Z]+$/;
            if(!regName.test($("#txtuname").val().trim())){
                alert("Invalid User Name");
                $("#txtuname").focus();
                return;
            }

            var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
            if(!($("#txtemail").val().trim().match(mailformat))){
                alert("Invalid Email");
                $("#txtemail").focus();
                return;
            }

            var phoneno = /^\d{10}$/;
             
            if(!($("#txtcontact").val().trim().match(phoneno))){
                alert('Please Enter a Valid Phone Numcer !');
                $("#txtcontact").focus();
                return;
            }

           for(p=0;p<allusersindb.length;p++){
               if($("#txtcontact").val().trim()==allusersindb[p].ContactNo){
                alert('Cannot add duplicat user !');
                $("#txtuname").focus();
                return;
               }
           }

            var user = {
                Name: $("#txtuname").val().trim(),
                Email: $("#txtemail").val().trim(),
                ContactNo: parseInt($("#txtcontact").val().trim()),
                Gender: $("#txtgender").val().trim()
            };
           

            var ajaxConfig = {
                method: "POST",
                url: SERVER_URL + "/v1/user/",
                async: true,
                contentType: "application/json",
                data: JSON.stringify(user)
            }


            $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {
                alert("Added Successfully");
                if(isNaN(response.Id/1)==true){
                alert('Invalid ID for QR!');
                return;
            }
                generateQR(response.Id,user.Name);
                loadAllCustomers();
                console.log("Response"+response.Id);
                $('button[type="reset"]').trigger("click");
            }).fail(function (jxhr, statusText, error) {
                alert("Unable to save the Employee, try again");
                console.log(error);
            });

        });

        $('button[type="reset"]').click(function () {
            $("#tblusers tbody tr").removeClass("selected-row");
            $("#txtCustomerId").attr("disabled", false);
            $("#btnSave").attr("disabled",false);
        });

        $(document).ready(function () {

            loadAllCustomers();

        });

        function clearText() {
            $("#txtCustomerId").val("");
            $("#txtCustomerName").val("");
        }


        function generateQR(user_id,username){
            var qr = new VanillaQR({
            url:user_id+":wixis360",
            width: 400,
            height: 400,
        });

        var img = qr.toImage("png");

        saveAs(img.src,username+".png");
        }


        function loadAllCustomers() {

            var ajaxConfig = {
                method: "GET",
                url: SERVER_URL + "/v1/user",
                async: true
            };
            $("#tblusers").dataTable().fnDestroy();
            $("#tblusers tbody tr").remove();
            $.ajax(ajaxConfig).done(function (customers, statusText, jxhr) {
                setallusers(customers);
                customers.forEach(function (customer) {

                    var html = `<tr>
                                <td>${customer.Id}</td>
                                <td>${customer.Name}</td>
                                <td align="center"><button type="button" class="btn btn-primary qrcode">Download QR</button></td>
                                <td align="center"><button type="button" class="btn btn-danger delete">Delete</button></td>
                            </tr>`;

                    $("#tblusers tbody").append(html);

                    $("#tblusers tbody tr").off("click");
                    $("#tblusers tbody tr").click(function () {
                        $("#tblusers tbody tr").removeClass("selected-row");
                        $(this).addClass("selected-row");
                        var uid=($(this).find("td:first-child").text());
                       customers.forEach(function(asd){
                           if(asd.Id==uid){
                            $("#txtuname").val(asd.Name);
                            $("#txtemail").val(asd.Email);
                            $("#txtcontact").val("0"+asd.ContactNo);
                            $("#txtgender").val(asd.Gender);
                           }
                       });
                        // $("#txtCustomerId").attr("disabled", true);
                        // $("#txtuname").val($(this).find("td:nth-child(2)").text());
                        $("#btnSave").attr("disabled",true);
                    });

                    $("button.delete").off("click");
                    $("button.delete").click(function (eventData) {

                        eventData.stopPropagation();

                        var row = $(this).parents("tr");
                        var customerId = (row.find("td:first-child").text());

                        if (confirm("Are you sure to delete this User?")) {

                            var ajaxConfig = {
                                method: "DELETE",
                                url: SERVER_URL + "/v1/user/" + customerId,
                                async: true
                            }

                            $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {

                                $(row).remove();

                            }).fail(function (jxhr, statusText, error) {

                                console.log(jxhr.responseText);

                            });
                        }
                    });

                    $("button.qrcode").off("click");
                    $("button.qrcode").click(function(generate){
                        generate.stopPropagation();
                        var row = $(this).parents("tr");
                        var userid = (row.find("td:first-child").text());
                        var username=(row.find("td:nth-child(2)").text());
                        generateQR(userid,username);
                    });

                });

                $('#tblusers').DataTable({
                    'paging': true,
                    'lengthChange': false,
                    'searching': true,
                    'ordering': true,
                    'info': true,
                    'autoWidth': true,
                    'pageLength': 5,
                    language: {
                        search: "_INPUT_",
                        searchPlaceholder: "Search Users..."
                    }
                });

            }).fail(function (jxhr, statusText, error) {
                console.log(error);
            });
        }

        function setallusers(allusers){
            allusersindb=allusers;
        }

    </script>


</body>

</html>